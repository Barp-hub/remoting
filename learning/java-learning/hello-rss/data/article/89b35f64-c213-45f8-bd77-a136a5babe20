<p>通过使用nginx的map可以配置按照不同的值（如URL参数，POST值,cooke，http头等等&#8230;）,来转到不用的后端主机，以实现简单的AB测试环境。</p>
<p>下面为一个配置的例子：</p><pre class="crayon-plain-tag"># underscores_in_headers on;
#当使用超过一个map时，下面两个参数需要调大，否则会报错
map_hash_max_size 262144;
map_hash_bucket_size 262144;

#定义3个upstream用于AB测试，用于显示不同的内容，相应下面有建3个虚拟主机端口与此对应
upstream def {
        server 127.0.0.1:8080;
}

upstream a {
        server 127.0.0.1:8081;
}

upstream b {
        server 127.0.0.1:8082;
}

# 定义map，$cookie_aid是指从cookie内取aid的值,当cookie内aid的值为"12345"时，$upserver为a，$upserver我这边是用的是upstrem的名称，其它类似
map $cookie_aid $upserver {
        default                          "def";
        "12345"                          "a";
        "67890"                          "b";
}
# 从$http_pid内取值,是从http header内取pid的的值,当http header内pid的值为"12345"时，$headerpid 为a，其它类似
map $http_pid $headerpid {
        default                          "def";
        "12345"                          "a";
        "67890"                          "b";
}
# 从$host内取值,$host对应的是用户访问的域名,当域名的值为12345.abtest-b.xxxxx.com时，$bserver 为a，其它类似
map $host $bserver {
		12345.abtest-b.xxxxx.com       "a";
		67890.abtest-b.xxxxx.com       "b";
		.abtest-b.xxxxx.com            "def";
		default                        "def";
}
# 从$arg_userid内取值,$arg_userid对应的是用户访问的URL上所带的参数userid的值,当userid的值为12345时，$userid为a，其它类似
map $arg_userid $userid {
        default                          "def";
        "12345"                          "a";
        "67890"                          "b";
}

server {
        listen 80;
        server_name abtest.xxxxx.com;
        charset utf-8;
        root /data/www/a/;
        access_log /data/log/nginx/abtest.internal.weimobdev.com_access.log main;
        error_log /data/log/nginx/abtest.internal.weimobdev.com_error.log info;

        location / {
                # 通过以下的if语句,实现多个变量的判断,当cookie内取aid的值判断完后，再判断http header内pid的值
                if ( $upserver = "def" ) {
                         set $upserver  $headerpid;
                }
                # 由于$upserver我这边是用的是upstrem的名称,所以可以直接转发
                proxy_pass http://$upserver;   
        }
}

server {
        listen 80;
        server_name abtest-b.xxxxx.com *.abtest-b.xxxxx.com;
        charset utf-8;
        root /data/www/a/;
        access_log /data/log/nginx/abtest-b.xxxxx.com_access.log main;
        error_log /data/log/nginx/abtest-b.xxxxx.com_error.log info;

        location / {
                # 通过以下的if语句,实现多个变量的判断,当$host内的域名判断完后，再判断URL上所带的参数userid的值
                if ( $bserver = "def" ) {
                         set $bserver $userid;
                }
                # 
                proxy_pass http://$bserver;
        }
}

server {
        listen 8080;
        charset utf-8;
        root /data/www/default/;
        access_log /data/log/nginx/default.log;
}

server {
        listen 8081;
        charset utf-8;
        root /data/www/a/;
        access_log /data/log/nginx/a.log;
}

server {
        listen 8082;
        charset utf-8;
        root /data/www/b/;
        access_log /data/log/nginx/b.log;
}</pre><p><span id="more-898"></span></p>
<p>配置好重载nginx配置，可以使用curl做测试, -b &#8220;aid=12345&#8243;为发送cookie aid，-H &#8220;pid:12345&#8243;为发送http header。</p>
<p>以下是nginx的内置参数：</p>
<p>nginx的配置文件中可以使用的内置变量以美元符$开始，也有人叫全局变量。其中，部分预定义的变量的值是可以改变的。</p>
<p>$arg_PARAMETER 这个变量值为：GET请求中变量名PARAMETER参数的值。</p>
<p>$args 这个变量等于GET请求中的参数。例如，foo=123&#38;bar=blahblah;这个变量只可以被修改</p>
<p>$binary_remote_addr 二进制码形式的客户端地址。</p>
<p>$body_bytes_sent 传送页面的字节数</p>
<p>$content_length 请求头中的Content-length字段。</p>
<p>$content_type 请求头中的Content-Type字段。</p>
<p>$cookie_COOKIE cookie COOKIE的值。</p>
<p>$document_root 当前请求在root指令中指定的值。</p>
<p>$document_uri 与$uri相同。</p>
<p>$host 请求中的主机头(Host)字段，如果请求中的主机头不可用或者空，则为处理请求的server名称(处理请求的server的server_name指令的值)。值为小写，不包含端口。</p>
<p>$hostname 机器名使用 gethostname系统调用的值</p>
<p>$http_HEADER HTTP请求头中的内容，HEADER为HTTP请求中的内容转为小写，-变为_(破折号变为下划线)，例如：$http_user_agent(Uaer-Agent的值), $http_referer&#8230;;</p>
<p>$sent_http_HEADER HTTP响应头中的内容，HEADER为HTTP响应中的内容转为小写，-变为_(破折号变为下划线)，例如： $sent_http_cache_control, $sent_http_content_type&#8230;;</p>
<p>$is_args 如果$args设置，值为&#8221;?&#8221;，否则为&#8221;&#8221;。</p>
<p>$limit_rate 这个变量可以限制连接速率。</p>
<p>$nginx_version 当前运行的nginx版本号。</p>
<p>$query_string 与$args相同。</p>
<p>$remote_addr 客户端的IP地址。</p>
<p>$remote_port 客户端的端口。</p>
<p>$remote_user 已经经过Auth Basic Module验证的用户名。</p>
<p>$request_filename 当前连接请求的文件路径，由root或alias指令与URI请求生成。</p>
<p>$request_body 这个变量（0.7.58+）包含请求的主要信息。在使用proxy_pass或fastcgi_pass指令的location中比较有意义。</p>
<p>$request_body_file 客户端请求主体信息的临时文件名。</p>
<p>$request_completion 如果请求成功，设为&#8221;OK&#8221;；如果请求未完成或者不是一系列请求中最后一部分则设为空。</p>
<p>$request_method 这个变量是客户端请求的动作，通常为GET或POST。<br />
包括0.8.20及之前的版本中，这个变量总为main request中的动作，如果当前请求是一个子请求，并不使用这个当前请求的动作。</p>
<p>$request_uri 这个变量等于包含一些客户端请求参数的原始URI，它无法修改，请查看$uri更改或重写URI。</p>
<p>$scheme 所用的协议，比如http或者是https，比如rewrite ^(.+)$ $scheme://example.com$1 redirect;</p>
<p>$server_addr 服务器地址，在完成一次系统调用后可以确定这个值，如果要绕开系统调用，则必须在listen中指定地址并且使用bind参数。</p>
<p>$server_name 服务器名称。</p>
<p>$server_port 请求到达服务器的端口号。</p>
<p>$server_protocol 请求使用的协议，通常是HTTP/1.0或HTTP/1.1。</p>
<p>$uri 请求中的当前URI(不带请求参数，参数位于$args)，不同于浏览器传递的$request_uri的值，它可以通过内部重定向，或者使用index指令进行修改。不包括协议和主机名，例如/foo/bar.html</p>
<p>使用curl 指定域名IP测试的例子：</p>
<p>方法一</p>
<p>curl url -x ip:port</p>
<p>例curl http://baidu.com -x 10.12.20.21:80</p>
<p>这个方法访问是正常，不过访问日志中$request字段显示的是”GET http://baidu.com”</p>
<p>方法二</p>
<p>curl -H ‘Host:baidu.com’ http://10.12.20.21</p>
<p>这个方法显示是正常的，日志也正常，推荐这种方法</p>
<p>更多例子：</p>
<p>-b/&#8211;cookie &#60;name=string/file&#62; Cookie string or file to read cookies from (H)<br />
-d/ &#8211;data &#60;data&#62; HTTP POST data (H)<br />
&#8211;data-ascii &#60;data&#62; HTTP POST ASCII data (H)<br />
&#8211;data-binary &#60;data&#62; HTTP POST binary data (H)<br />
&#8211;data-urlencode &#60;name=data/name@filename&#62; HTTP POST data url encoded (H)<br />
&#8211;delegation STRING GSS-API delegation permission<br />
&#8211;digest Use HTTP Digest Authentication (H)<br />
&#8211;disable-eprt Inhibit using EPRT or LPRT (F)<br />
&#8211;disable-epsv Inhibit using EPSV (F)<br />
-H/&#8211;header &#60;line&#62; Custom header to pass to server (H)<br />
-I/&#8211;head Show document info only</p>
<p>curl http://1234.m.xxx.com/o2o/ -x 127.0.0.1:80</p>
<p>curl -b &#8220;aid=55875671&#8221; -H &#8216;Host:o2oopen.xxx.com&#8217; http://127.0.0.1/</p>
<p>curl -v -H &#8216;pid:55875671&#8217; -b &#8220;aid=55875671&#8221; -x http://127.0.0.1:80 http://o2oopen.xxx.com/</p>
<p>curl -v -H &#8216;pid:1234&#8217; -b &#8220;aid=55875671&#8221; -x http://127.0.0.1:80 http://o2oopen.xxx.com/</p>
<p>&#160;</p>
<p>&#160;</p>
